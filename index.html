<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IJP MONITORING SYSTEM - SUPABASE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/+esm" type="importmap"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&amp;family=Rajdhani:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            orbitron: ['Orbitron', 'monospace'],
            rajdhani: ['Rajdhani', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    .glow-effect {
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }
    .card-gradient {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 136, 255, 0.1) 100%);
    }
    .dark .card-gradient {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 136, 255, 0.05) 100%);
    }
    .pulse-dot {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .critical-pulse {
      animation: criticalPulse 1s infinite;
    }
    @keyframes criticalPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .blink-warning {
      animation: blinkWarning 0.6s infinite;
    }
    @keyframes blinkWarning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .blink-critical {
      animation: blinkCritical 0.4s infinite;
    }
    @keyframes blinkCritical {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.05); }
    }
    .nav-active {
      background: linear-gradient(90deg, #00ff88 0%, #00aaff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: #00ff88;
      border-radius: 3px;
    }
  </style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full font-rajdhani bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="app" class="h-full w-full flex flex-col overflow-auto"><!-- Header -->
   <header class="bg-white dark:bg-gray-800 shadow-lg border-b-2 border-emerald-500 px-4 py-3">
    <div class="flex items-center justify-between">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
       </svg>
      </div>
      <div>
       <h1 class="font-orbitron font-bold text-lg md:text-xl text-emerald-600 dark:text-emerald-400 uppercase tracking-wider">IJP MONITORING SYSTEM</h1>
       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-widest">SUPABASE POWERED</p>
      </div>
     </div>
     <div class="flex items-center gap-3">
      <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30"><span class="w-2 h-2 rounded-full bg-emerald-500 pulse-dot"></span> <span class="text-xs font-semibold text-emerald-700 dark:text-emerald-400 uppercase">SYSTEM ONLINE</span>
      </div><button id="theme-toggle" type="button" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Toggle dark mode">
       <svg id="sun-icon" class="w-5 h-5 text-yellow-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
       </svg>
       <svg id="moon-icon" class="w-5 h-5 text-gray-700 hidden" fill="currentColor" viewbox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
       </svg></button>
     </div>
    </div>
   </header><!-- Navigation -->
   <nav class="bg-white dark:bg-gray-800 shadow-md px-4 py-2 border-b border-gray-200 dark:border-gray-700">
    <div class="flex gap-1 overflow-x-auto"><button data-nav="dashboard" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold text-sm uppercase tracking-wide transition-all bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg><span>DASHBOARD</span> </button> <button data-nav="form" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold text-sm uppercase tracking-wide transition-all hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg><span>FORM INPUT IJP</span> </button> <button data-nav="management" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold text-sm uppercase tracking-wide transition-all hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
      </svg><span>MANAGEMENT</span> </button> <button data-nav="audit" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold text-sm uppercase tracking-wide transition-all hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg><span>AUDIT TRAIL</span> </button>
    </div>
   </nav><!-- Main Content -->
   <main class="flex-1 p-4 md:p-6 overflow-auto"><!-- Dashboard Page -->
    <section id="page-dashboard" class="page">
     <div class="mb-6 flex items-center justify-between">
      <div>
       <h2 class="font-orbitron font-bold text-2xl text-gray-800 dark:text-white uppercase mb-2">DASHBOARD OVERVIEW</h2>
       <p class="text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wide">REAL-TIME INK JET PRINTER MONITORING STATUS</p>
      </div>
      <div class="flex gap-2"><button id="export-monitoring" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white font-bold rounded-lg uppercase hover:bg-blue-600 transition-all shadow-lg text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg> EXPORT MONITORING </button>
      </div>
     </div><!-- Critical Alerts -->
     <div id="critical-alerts" class="mb-6"></div><!-- Stats Cards -->
     <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="card-gradient bg-white dark:bg-gray-800 rounded-xl p-4 border border-emerald-200 dark:border-emerald-800 shadow-lg">
       <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center">
         <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
         </svg>
        </div><span class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase">TOTAL</span>
       </div>
       <p id="stat-total" class="font-orbitron text-3xl font-bold text-gray-800 dark:text-white">0</p>
       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">IJP UNITS</p>
      </div>
      <div class="card-gradient bg-white dark:bg-gray-800 rounded-xl p-4 border border-cyan-200 dark:border-cyan-800 shadow-lg">
       <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-900/50 flex items-center justify-center">
         <svg class="w-5 h-5 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div><span class="text-xs font-bold text-cyan-600 dark:text-cyan-400 uppercase">ACTIVE</span>
       </div>
       <p id="stat-active" class="font-orbitron text-3xl font-bold text-gray-800 dark:text-white">0</p>
       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">MONITORED</p>
      </div>
      <div class="card-gradient bg-white dark:bg-gray-800 rounded-xl p-4 border border-purple-200 dark:border-purple-800 shadow-lg">
       <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center">
         <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
         </svg>
        </div><span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase">LINES</span>
       </div>
       <p id="stat-lines" class="font-orbitron text-3xl font-bold text-gray-800 dark:text-white">0</p>
       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">ACTIVE LINES</p>
      </div>
      <div class="card-gradient bg-white dark:bg-gray-800 rounded-xl p-4 border border-red-200 dark:border-red-800 shadow-lg">
       <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/50 flex items-center justify-center">
         <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2M6 9v2a6 6 0 0012 0V9m-3 7h6a2 2 0 002-2v-5a2 2 0 00-2-2h-6a2 2 0 00-2 2v5a2 2 0 002 2z" />
         </svg>
        </div><span class="text-xs font-bold text-red-600 dark:text-red-400 uppercase">PROBLEM</span>
       </div>
       <p id="stat-problems" class="font-orbitron text-3xl font-bold text-gray-800 dark:text-white">0</p>
       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">ACTIVE ISSUES</p>
      </div>
     </div><!-- Charts Grid -->
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><!-- Monitoring Chart -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
       <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase">OPERATION TIME CHART</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">‚ö†Ô∏è WARNING: 5000 HRS | üî¥ CRITICAL: 10000 HRS</p>
       </div>
       <div class="p-4 md:p-6">
        <div style="position: relative; height: 300px; width: 100%;">
         <canvas id="monitoring-chart"></canvas>
        </div>
       </div>
      </div><!-- Problem Summary Chart -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
       <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase">PROBLEM SUMMARY</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mt-1">ACTIVE ISSUES BY TYPE</p>
       </div>
       <div class="p-4 md:p-6">
        <div style="position: relative; height: 300px; width: 100%;">
         <canvas id="problem-chart"></canvas>
        </div>
       </div>
      </div>
     </div><!-- Problem Issues Section -->
     <div id="problem-issues-section" class="mb-6 hidden">
      <h3 class="font-orbitron font-bold text-xl text-gray-800 dark:text-white uppercase mb-4">ACTIVE PROBLEMS &amp; ACTIONS</h3>
      <div id="problem-issues-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
     </div><!-- Monitoring Table -->
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
       <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase">MONITORING DATA</h3>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-900">
         <tr>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">LINE</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">SERIAL NUMBER</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">MACHINE</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">OP TIME</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">KONDISI</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">PROBLEM</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">STATUS</th>
         </tr>
        </thead>
        <tbody id="monitoring-table" class="divide-y divide-gray-200 dark:divide-gray-700">
         <tr>
          <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO MONITORING DATA AVAILABLE</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><!-- Form Assessment Page -->
    <section id="page-form" class="page hidden">
     <div class="mb-6">
      <h2 class="font-orbitron font-bold text-2xl text-gray-800 dark:text-white uppercase mb-2">FORM INPUT IJP</h2>
      <p class="text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wide">INPUT DATA MONITORING INK JET PRINTER</p>
     </div>
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
      <form id="monitoring-form" class="space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="line" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">LINE</label> <select id="line" name="line" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"> <option value="">SELECT LINE</option> <option value="LINE01">LINE01</option> <option value="LINE02">LINE02</option> <option value="LINE03">LINE03</option> <option value="LINE04">LINE04</option> <option value="LINE05">LINE05</option> <option value="LINE06">LINE06</option> <option value="LINE07">LINE07</option> <option value="LINE08">LINE08</option> <option value="LINE09">LINE09</option> </select>
        </div>
        <div><label for="serial_number" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">SERIAL NUMBER IJP</label> <input type="text" id="serial_number" name="serial_number" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ENTER SERIAL NUMBER">
        </div>
        <div><label for="machine" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">MESIN</label> <input type="text" id="machine" name="machine" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ENTER MACHINE NAME">
        </div>
        <div><label for="cumulative_op_time" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">CUMULATIVE OP TIME (HOURS)</label> <input type="number" id="cumulative_op_time" name="cumulative_op_time" required min="0" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="0">
        </div>
        <div><label for="ijp_condition" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">KONDISI IJP</label> <select id="ijp_condition" name="ijp_condition" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"> <option value="">SELECT CONDITION</option> <option value="OK">OK</option> <option value="NOT OK">NOT OK</option> </select>
        </div>
        <div><label for="problem_exists" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">ADA PROBLEM ?</label> <select id="problem_exists" name="problem_exists" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"> <option value="">SELECT</option> <option value="TIDAK ADA">TIDAK ADA</option> <option value="ADA">ADA</option> </select>
        </div>
       </div><!-- Problem Description (Conditional) -->
       <div id="problem-section" class="hidden border-t-2 border-gray-300 dark:border-gray-600 pt-6 mt-6">
        <div class="mb-6"><label for="problem_description" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">DESKRIPSI PROBLEM</label> <textarea id="problem_description" name="problem_description" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all resize-none" placeholder="JELASKAN PROBLEM YANG TERJADI..."></textarea>
        </div>
        <div class="mb-6"><label for="problem_action" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">ACTION / SOLUSI</label> <textarea id="problem_action" name="problem_action" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all resize-none" placeholder="TINDAKAN ATAU SOLUSI YANG DIAMBIL..."></textarea>
        </div>
        <div class="pt-6 border-t border-gray-300 dark:border-gray-600"><label for="photo_upload" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">üì∏ UPLOAD FOTO IJP (MAX 5MB)</label>
         <div class="flex items-center gap-4 mb-3"><input type="file" id="photo_upload" name="photo_upload" accept="image/*" class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-emerald-500 file:text-white hover:file:bg-emerald-600">
          <div id="photo-preview" class="hidden w-20 h-20 rounded-lg overflow-hidden border-2 border-emerald-400 shadow-lg"><img id="preview-img" src="" alt="Preview" class="w-full h-full object-cover">
          </div>
         </div>
         <p id="photo-filename" class="text-xs text-gray-500 dark:text-gray-400 uppercase">NO FILE SELECTED</p>
        </div>
       </div>
       <div><label for="notes" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">CATATAN KHUSUS</label> <textarea id="notes" name="notes" rows="4" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all resize-none" placeholder="MASUKKAN SARAN PERBAIKAN..."></textarea>
       </div>
       <div class="flex gap-4"><button type="submit" id="submit-monitoring" class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-bold rounded-lg uppercase tracking-wide hover:from-emerald-600 hover:to-cyan-600 transition-all shadow-lg">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
         </svg> SUBMIT DATA </button> <button type="reset" id="reset-form" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold rounded-lg uppercase tracking-wide hover:bg-gray-300 dark:hover:bg-gray-600 transition-all"> RESET </button>
       </div>
      </form><!-- Success Message -->
      <div id="form-success" class="hidden mt-4 p-4 bg-emerald-100 dark:bg-emerald-900/30 border border-emerald-300 dark:border-emerald-700 rounded-lg">
       <p class="text-emerald-700 dark:text-emerald-400 font-semibold uppercase">‚úì DATA SUBMITTED SUCCESSFULLY!</p>
      </div>
     </div>
    </section><!-- Management Page -->
    <section id="page-management" class="page hidden">
     <div class="mb-6 flex items-center justify-between">
      <div>
       <h2 class="font-orbitron font-bold text-2xl text-gray-800 dark:text-white uppercase mb-2">MANAGEMENT</h2>
       <p class="text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wide">UPLOAD &amp; MANAGE IJP SERIAL NUMBER DATA</p>
      </div><button id="export-management" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white font-bold rounded-lg uppercase hover:bg-green-600 transition-all shadow-lg text-sm">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
       </svg> EXPORT MANAGEMENT </button>
     </div><!-- Upload Form -->
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase mb-4">ADD IJP DATA</h3>
      <form id="management-form" class="space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div><label for="machine_name" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">NAMA MESIN</label> <input type="text" id="machine_name" name="machine_name" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ENTER MACHINE NAME">
        </div>
        <div><label for="line_mg" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">LINE</label> <input type="text" id="line_mg" name="line_mg" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ENTER LINE">
        </div>
        <div><label for="service" class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">SERIAL NUMBER IJP</label> <input type="text" id="service" name="service" required class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white uppercase focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ENTER SERIAL NUMBER IJP">
        </div>
       </div><button type="submit" id="submit-management" class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-bold rounded-lg uppercase tracking-wide hover:from-emerald-600 hover:to-cyan-600 transition-all shadow-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg> UPLOAD DATA </button>
      </form><!-- Success Message -->
      <div id="management-success" class="hidden mt-4 p-4 bg-emerald-100 dark:bg-emerald-900/30 border border-emerald-300 dark:border-emerald-700 rounded-lg">
       <p class="text-emerald-700 dark:text-emerald-400 font-semibold uppercase">‚úì DATA UPLOADED SUCCESSFULLY!</p>
      </div>
     </div><!-- Management Table -->
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
       <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase">IJP REGISTRY</h3>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gray-50 dark:bg-gray-900">
         <tr>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">NAMA MESIN</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">LINE</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">SERIAL NUMBER IJP</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">ACTIONS</th>
         </tr>
        </thead>
        <tbody id="management-table" class="divide-y divide-gray-200 dark:divide-gray-700">
         <tr>
          <td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO IJP DATA REGISTERED</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><!-- Audit Trail Page -->
    <section id="page-audit" class="page hidden">
     <div class="mb-6 flex items-center justify-between">
      <div>
       <h2 class="font-orbitron font-bold text-2xl text-gray-800 dark:text-white uppercase mb-2">AUDIT TRAIL</h2>
       <p class="text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wide">SYSTEM ACTIVITY LOG</p>
      </div><button id="export-audit" class="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white font-bold rounded-lg uppercase hover:bg-orange-600 transition-all shadow-lg text-sm">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
       </svg> EXPORT AUDIT TRAIL </button>
     </div>
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
       <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase">ACTIVITY LOG <span id="audit-count" class="ml-4 px-3 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-sm font-bold rounded-full uppercase">0 RECORDS</span></h3>
      </div>
      <div class="overflow-x-auto max-h-96">
       <table class="w-full">
        <thead class="bg-gray-50 dark:bg-gray-900 sticky top-0">
         <tr>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">TIMESTAMP</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">ACTION</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">DETAILS</th>
         </tr>
        </thead>
        <tbody id="audit-table" class="divide-y divide-gray-200 dark:divide-gray-700">
         <tr>
          <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO ACTIVITY RECORDED</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section>
   </main><!-- Footer -->
   <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-3">
    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 uppercase"><span>¬© 2024 IJP MONITORING SYSTEM - SUPABASE POWERED</span> <span id="current-time" class="font-orbitron"></span>
    </div>
   </footer>
  </div><!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
   <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
    <h3 class="font-orbitron font-bold text-lg text-gray-800 dark:text-white uppercase mb-4">CONFIRM DELETE</h3>
    <p class="text-gray-600 dark:text-gray-400 uppercase mb-6">ARE YOU SURE YOU WANT TO DELETE THIS RECORD?</p>
    <div class="flex gap-4"><button id="confirm-delete" class="flex-1 px-4 py-2 bg-red-500 text-white font-bold rounded-lg uppercase hover:bg-red-600 transition-all">DELETE</button> <button id="cancel-delete" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold rounded-lg uppercase hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">CANCEL</button>
    </div>
   </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    // Supabase Setup
    const SUPABASE_URL = 'https://okdvksrprvhgqdyioryf.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZHZrc3JwcnZoZ3FkeWlvcnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5Mjc5OTYsImV4cCI6MjA4NjUwMzk5Nn0.cfrGXxCgbPWpEdhBGC6RP8JonSTCjN1d6IOr4qyXSQw'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // App State
    let allData = []
    let deleteTarget = null
    let chartInstance = null
    let problemChartInstance = null

    // Initialize
    async function init() {
      setupThemeToggle()
      setupNavigation()
      setupForms()
      setupDeleteModal()
      setupExportButtons()
      updateClock()
      setInterval(updateClock, 1000)

      // Load initial data
      await loadAllData()

      // Subscribe to real-time updates
      subscribeToChanges()
    }

    // Load all data from Supabase
    async function loadAllData() {
      try {
        console.log('Loading data...')
        
        // Load monitoring data
        const { data: monitoringData, error: monitoringError } = await supabase
          .from('monitoring_data')
          .select('*')
          .order('created_at', { ascending: false })

        if (monitoringError) throw monitoringError

        // Load management data
        const { data: managementData, error: managementError } = await supabase
          .from('management_data')
          .select('*')
          .order('created_at', { ascending: false })

        if (managementError) throw managementError

        console.log('Management data loaded:', managementData)

        // Load audit data
        const { data: auditData, error: auditError } = await supabase
          .from('audit_logs')
          .select('*')
          .order('created_at', { ascending: false })

        if (auditError) throw auditError

        // Combine all data
        allData = [
          ...monitoringData.map(d => ({ ...d, table_type: 'monitoring' })),
          ...managementData.map(d => ({ ...d, table_type: 'management' })),
          ...auditData.map(d => ({ ...d, table_type: 'audit' }))
        ]

        updateDashboard()
        updateMonitoringTable()
        updateManagementTable()
        updateAuditTable()
        updateCriticalAlerts()
      } catch (error) {
        console.error('Error loading data:', error)
        showFormMessage('form-success', 'ERROR LOADING DATA', true)
      }
    }

    // Subscribe to real-time changes
    function subscribeToChanges() {
      supabase
        .channel('monitoring_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'monitoring_data' }, () => {
          console.log('Monitoring data changed')
          loadAllData()
        })
        .subscribe()

      supabase
        .channel('management_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'management_data' }, () => {
          console.log('Management data changed')
          loadAllData()
        })
        .subscribe()

      supabase
        .channel('audit_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'audit_logs' }, () => {
          console.log('Audit data changed')
          loadAllData()
        })
        .subscribe()
    }

    // Theme Toggle
    function setupThemeToggle() {
      const toggle = document.getElementById('theme-toggle')
      const html = document.documentElement
      const sunIcon = document.getElementById('sun-icon')
      const moonIcon = document.getElementById('moon-icon')

      const initializeTheme = () => {
        const saved = localStorage.getItem('theme')
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
        
        if (saved === 'dark' || (!saved && prefersDark)) {
          html.classList.add('dark')
          sunIcon.classList.add('hidden')
          moonIcon.classList.remove('hidden')
        } else {
          html.classList.remove('dark')
          sunIcon.classList.remove('hidden')
          moonIcon.classList.add('hidden')
        }
      }

      initializeTheme()

      toggle.addEventListener('click', () => {
        const isDark = html.classList.toggle('dark')
        localStorage.setItem('theme', isDark ? 'dark' : 'light')
        
        if (isDark) {
          sunIcon.classList.add('hidden')
          moonIcon.classList.remove('hidden')
        } else {
          sunIcon.classList.remove('hidden')
          moonIcon.classList.add('hidden')
        }
      })
    }

    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.dataset.nav
          showPage(page)
          updateNavButtons(btn)
        })
      })
    }

    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'))
      document.getElementById(`page-${page}`).classList.remove('hidden')
    }

    function updateNavButtons(activeBtn) {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-400')
        btn.classList.add('text-gray-600', 'dark:text-gray-400')
      })
      activeBtn.classList.add('bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-400')
      activeBtn.classList.remove('text-gray-600', 'dark:text-gray-400')
    }

    // Forms
    function setupForms() {
      const problemExistsSelect = document.getElementById('problem_exists')
      const problemSection = document.getElementById('problem-section')

      // Photo upload preview
      document.getElementById('photo_upload').addEventListener('change', (e) => {
        const file = e.target.files[0]
        const preview = document.getElementById('photo-preview')
        const filename = document.getElementById('photo-filename')
        
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            filename.textContent = 'ERROR: FILE SIZE EXCEEDS 5MB'
            return
          }
          
          const reader = new FileReader()
          reader.onload = (event) => {
            document.getElementById('preview-img').src = event.target.result
            preview.classList.remove('hidden')
            filename.textContent = `FILE: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`
          }
          reader.readAsDataURL(file)
        } else {
          preview.classList.add('hidden')
          filename.textContent = 'NO FILE SELECTED'
        }
      })

      problemExistsSelect.addEventListener('change', () => {
        if (problemExistsSelect.value === 'ADA') {
          problemSection.classList.remove('hidden')
        } else {
          problemSection.classList.add('hidden')
          document.getElementById('problem_description').value = ''
          document.getElementById('problem_action').value = ''
          document.getElementById('photo_upload').value = ''
          document.getElementById('photo-preview').classList.add('hidden')
          document.getElementById('photo-filename').textContent = 'NO FILE SELECTED'
        }
      })

      document.getElementById('monitoring-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const btn = document.getElementById('submit-monitoring')
        btn.disabled = true
        btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> SUBMITTING...'

        try {
          let photoUrl = ''
          const photoFile = document.getElementById('photo_upload').files[0]

          // Upload photo if exists and problem exists
          if (photoFile && document.getElementById('problem_exists').value === 'ADA') {
            // Generate safe filename
            const timestamp = Date.now()
            const safeName = photoFile.name.replace(/[^a-zA-Z0-9.-]/g, '_').slice(-50)
            const filename = `ijp-photos/${timestamp}-${safeName}`
            
            const { error: uploadError } = await supabase.storage
              .from('ijp_monitoring')
              .upload(filename, photoFile)

            if (uploadError) {
              console.warn('Photo upload warning:', uploadError)
              // Continue without photo if upload fails
            } else {
              const { data } = supabase.storage.from('ijp_monitoring').getPublicUrl(filename)
              photoUrl = data.publicUrl
            }
          }

          const formData = {
            line: document.getElementById('line').value.toUpperCase(),
            serial_number: document.getElementById('serial_number').value.toUpperCase(),
            machine: document.getElementById('machine').value.toUpperCase(),
            cumulative_op_time: parseInt(document.getElementById('cumulative_op_time').value) || 0,
            ijp_condition: document.getElementById('ijp_condition').value.toUpperCase(),
            problem_exists: document.getElementById('problem_exists').value.toUpperCase(),
            problem_description: document.getElementById('problem_description').value || '',
            problem_action: document.getElementById('problem_action').value || '',
            notes: document.getElementById('notes').value,
            photo_url: photoUrl
          }

          const { error } = await supabase
            .from('monitoring_data')
            .insert([formData])

          if (error) throw error

          showFormMessage('form-success', '‚úì DATA SUBMITTED SUCCESSFULLY!')
          document.getElementById('monitoring-form').reset()
          problemSection.classList.add('hidden')
          document.getElementById('photo-preview').classList.add('hidden')
          document.getElementById('photo-filename').textContent = 'NO FILE SELECTED'

          await logAudit('MONITORING DATA ADDED', `SERIAL: ${formData.serial_number}, OP TIME: ${formData.cumulative_op_time} HRS${photoUrl ? ', PHOTO' : ''}`)
        } catch (error) {
          console.error('Error:', error)
          showFormMessage('form-success', `ERROR: ${error.message}`, true)
        } finally {
          btn.disabled = false
          btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg> SUBMIT DATA'
        }
      })

      document.getElementById('monitoring-form').addEventListener('reset', () => {
        problemSection.classList.add('hidden')
        document.getElementById('photo-preview').classList.add('hidden')
        document.getElementById('photo-filename').textContent = 'NO FILE SELECTED'
      })

      document.getElementById('management-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const btn = document.getElementById('submit-management')
        btn.disabled = true
        btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> UPLOADING...'

        const formData = {
          machine_name: document.getElementById('machine_name').value.toUpperCase(),
          line: document.getElementById('line_mg').value.toUpperCase(),
          serial_number: document.getElementById('service').value.toUpperCase()
        }

        try {
          console.log('Submitting management data:', formData)
          
          const { data, error } = await supabase
            .from('management_data')
            .insert([formData])
            .select()

          console.log('Insert response:', { data, error })

          if (error) throw error

          document.getElementById('management-form').reset()
          showFormMessage('management-success', '‚úì DATA UPLOADED SUCCESSFULLY!')
          
          // Force reload data
          await new Promise(resolve => setTimeout(resolve, 1000))
          await loadAllData()
          
          await logAudit('IJP REGISTERED', `MACHINE: ${formData.machine_name}`)
        } catch (error) {
          console.error('Error:', error)
          showFormMessage('management-success', `ERROR: ${error.message}`, true)
        } finally {
          btn.disabled = false
          btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg> UPLOAD DATA'
        }
      })
    }

    function showFormMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId)
      el.innerHTML = `<p class="${isError ? 'text-red-700 dark:text-red-400' : 'text-emerald-700 dark:text-emerald-400'} font-semibold uppercase">${message}</p>`
      el.classList.remove('hidden')
      setTimeout(() => el.classList.add('hidden'), 3000)
    }

    // Delete Modal
    function setupDeleteModal() {
      document.getElementById('cancel-delete').addEventListener('click', () => {
        document.getElementById('delete-modal').classList.add('hidden')
        deleteTarget = null
      })

      document.getElementById('confirm-delete').addEventListener('click', async () => {
        if (deleteTarget) {
          const btn = document.getElementById('confirm-delete')
          btn.disabled = true
          btn.textContent = 'DELETING...'

          try {
            const { error } = await supabase
              .from('management_data')
              .delete()
              .eq('id', deleteTarget.id)

            if (error) throw error

            await logAudit('RECORD DELETED', `ID: ${deleteTarget.id}`)
          } catch (error) {
            console.error('Error:', error)
            showFormMessage('form-success', `ERROR: ${error.message}`, true)
          } finally {
            btn.disabled = false
            btn.textContent = 'DELETE'
            document.getElementById('delete-modal').classList.add('hidden')
            deleteTarget = null
          }
        }
      })
    }

    function showDeleteModal(record) {
      deleteTarget = record
      document.getElementById('delete-modal').classList.remove('hidden')
    }

    // Export Functions
    function setupExportButtons() {
      document.getElementById('export-monitoring').addEventListener('click', exportMonitoringData)
      document.getElementById('export-management').addEventListener('click', exportManagementData)
      document.getElementById('export-audit').addEventListener('click', exportAuditData)
    }

    function exportMonitoringData() {
      const monitoringData = allData.filter(d => d.table_type === 'monitoring')
      
      if (monitoringData.length === 0) {
        showFormMessage('form-success', 'NO MONITORING DATA TO EXPORT', true)
        return
      }

      const wsData = monitoringData.map(item => ({
        'LINE': item.line || '-',
        'SERIAL NUMBER': item.serial_number || '-',
        'MACHINE': item.machine || '-',
        'CUMULATIVE OP TIME (HOURS)': item.cumulative_op_time || 0,
        'KONDISI IJP': item.ijp_condition || '-',
        'PROBLEM': item.problem_exists || '-',
        'DESKRIPSI': item.problem_description || '-',
        'ACTION': item.problem_action || '-',
        'NOTES': item.notes || '-',
        'PHOTO': item.photo_url ? 'YES' : 'NO',
        'TIMESTAMP': new Date(item.created_at).toLocaleString()
      }))

      const ws = XLSX.utils.json_to_sheet(wsData)
      const wb = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(wb, ws, 'Monitoring Data')
      XLSX.writeFile(wb, `monitoring-data-${new Date().toISOString().split('T')[0]}.xlsx`)
    }

    function exportManagementData() {
      const managementData = allData.filter(d => d.table_type === 'management')
      
      if (managementData.length === 0) {
        showFormMessage('form-success', 'NO MANAGEMENT DATA TO EXPORT', true)
        return
      }

      const wsData = managementData.map(item => ({
        'NAMA MESIN': item.machine_name || '-',
        'LINE': item.line || '-',
        'SERIAL NUMBER IJP': item.serial_number || '-',
        'TIMESTAMP': new Date(item.created_at).toLocaleString()
      }))

      const ws = XLSX.utils.json_to_sheet(wsData)
      const wb = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(wb, ws, 'Management Data')
      XLSX.writeFile(wb, `management-data-${new Date().toISOString().split('T')[0]}.xlsx`)
    }

    function exportAuditData() {
      const auditData = allData.filter(d => d.table_type === 'audit')
      
      if (auditData.length === 0) {
        showFormMessage('form-success', 'NO AUDIT DATA TO EXPORT', true)
        return
      }

      const wsData = auditData.map(item => ({
        'TIMESTAMP': new Date(item.created_at).toLocaleString(),
        'ACTION': item.user_action || '-',
        'DETAILS': item.activity || '-'
      }))

      const ws = XLSX.utils.json_to_sheet(wsData)
      const wb = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(wb, ws, 'Audit Trail')
      XLSX.writeFile(wb, `audit-trail-${new Date().toISOString().split('T')[0]}.xlsx`)
    }

    // Log Audit
    async function logAudit(action, details) {
      try {
        await supabase.from('audit_logs').insert([{ user_action: action, activity: details }])
      } catch (error) {
        console.error('Error logging audit:', error)
      }
    }

    // Update Monitoring Chart
    function updateMonitoringChart(monitoringData) {
      const canvas = document.getElementById('monitoring-chart')
      if (!canvas) return

      const chartData = monitoringData.map(d => ({
        machine: d.machine || 'UNKNOWN',
        opTime: d.cumulative_op_time || 0
      })).sort((a, b) => a.opTime - b.opTime)

      const labels = chartData.map(d => d.machine)
      const values = chartData.map(d => d.opTime)

      const ctx = canvas.getContext('2d')

      if (chartInstance) {
        chartInstance.destroy()
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'CUMULATIVE OP TIME (HOURS)',
              data: values,
              backgroundColor: values.map(v => {
                if (v >= 10000) return '#ef4444'
                if (v >= 5000) return '#f59e0b'
                return '#10b981'
              }),
              borderColor: values.map(v => {
                if (v >= 10000) return '#dc2626'
                if (v >= 5000) return '#d97706'
                return '#059669'
              }),
              borderWidth: 2,
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                font: {
                  family: "'Rajdhani', sans-serif",
                  size: 12,
                  weight: 'bold'
                },
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151',
                padding: 15
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: Math.max(12000, Math.max(...values, 0) * 1.1),
              ticks: {
                font: {
                  family: "'Rajdhani', sans-serif",
                  size: 11
                },
                color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'
              },
              grid: {
                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                font: {
                  family: "'Rajdhani', sans-serif",
                  size: 11,
                  weight: 'bold'
                },
                color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'
              },
              grid: {
                display: false
              }
            }
          }
        }
      })
    }

    // Update Problem Chart
    function updateProblemChart(monitoringData) {
      const canvas = document.getElementById('problem-chart')
      if (!canvas) return

      const problemCount = monitoringData.filter(d => d.problem_exists === 'ADA').length
      const normalCount = monitoringData.filter(d => d.problem_exists === 'TIDAK ADA').length

      const ctx = canvas.getContext('2d')

      if (problemChartInstance) {
        problemChartInstance.destroy()
      }

      problemChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['PROBLEM FOUND', 'NORMAL'],
          datasets: [
            {
              data: [problemCount, normalCount],
              backgroundColor: ['#ef4444', '#10b981'],
              borderColor: ['#dc2626', '#059669'],
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                font: {
                  family: "'Rajdhani', sans-serif",
                  size: 12,
                  weight: 'bold'
                },
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151',
                padding: 15
              }
            }
          }
        }
      })
    }

    // Update Critical Alerts
    function updateCriticalAlerts() {
      const container = document.getElementById('critical-alerts')
      const monitoringData = allData.filter(d => d.table_type === 'monitoring')
      const criticalItems = monitoringData.filter(d => d.cumulative_op_time > 10000)
      
      if (criticalItems.length === 0) {
        container.innerHTML = ''
        return
      }

      container.innerHTML = criticalItems.map(item => `
        <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 dark:border-red-600 rounded-xl p-4 mb-4 shadow-lg">
          <div class="flex items-start gap-3">
            <div class="text-3xl critical-pulse">‚ö†Ô∏è</div>
            <div class="flex-1">
              <h3 class="font-orbitron font-bold text-red-700 dark:text-red-400 uppercase mb-1">CRITICAL - SERVICE REQUIRED</h3>
              <p class="text-red-600 dark:text-red-300 font-semibold uppercase mb-2">FILTER SET REPLACEMENT NEEDED</p>
              <p class="text-sm text-red-600 dark:text-red-300 uppercase">
                <strong>LINE:</strong> ${item.line || '-'} | 
                <strong>SERIAL:</strong> ${item.serial_number || '-'} | 
                <strong>OP TIME:</strong> ${item.cumulative_op_time} HRS (>10000)
              </p>
            </div>
          </div>
        </div>
      `).join('')
    }

    // Update Problem Issues Section
    function updateProblemIssues(monitoringData) {
      const problemData = monitoringData.filter(d => d.problem_exists === 'ADA')
      const section = document.getElementById('problem-issues-section')
      const container = document.getElementById('problem-issues-container')

      if (problemData.length === 0) {
        section.classList.add('hidden')
        return
      }

      section.classList.remove('hidden')
      container.innerHTML = problemData.map(item => `
        <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded-lg p-4 shadow-md">
          <div class="flex items-start gap-3">
            <div class="text-2xl">üî¥</div>
            <div class="flex-1">
              <p class="font-bold text-red-700 dark:text-red-400 uppercase mb-1">${item.machine || 'UNKNOWN'}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400 uppercase mb-2"><strong>LINE:</strong> ${item.line || '-'} | <strong>SERIAL:</strong> ${item.serial_number || '-'}</p>
              <div class="bg-white dark:bg-gray-800 rounded p-2 mb-2">
                <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase mb-1">PROBLEM:</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">${item.problem_description || 'TIDAK ADA DESKRIPSI'}</p>
              </div>
              <div class="bg-white dark:bg-gray-800 rounded p-2">
                <p class="text-xs font-semibold text-green-700 dark:text-green-300 uppercase mb-1">ACTION TAKEN:</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">${item.problem_action || 'TIDAK ADA ACTION'}</p>
              </div>
              ${item.photo_url ? `<div class="mt-2"><p class="text-xs text-blue-600 dark:text-blue-400 uppercase">üì∏ <a href="${item.photo_url}" target="_blank" rel="noopener noreferrer">VIEW PHOTO</a></p></div>` : ''}
            </div>
          </div>
        </div>
      `).join('')
    }

    // Update Dashboard
    function updateDashboard() {
      const monitoringData = allData.filter(d => d.table_type === 'monitoring')
      const managementData = allData.filter(d => d.table_type === 'management')
      const problemsCount = monitoringData.filter(d => d.problem_exists === 'ADA').length
      
      document.getElementById('stat-total').textContent = managementData.length
      document.getElementById('stat-active').textContent = monitoringData.length
      document.getElementById('stat-problems').textContent = problemsCount
      
      const lines = new Set(monitoringData.map(d => d.line))
      document.getElementById('stat-lines').textContent = lines.size

      updateMonitoringChart(monitoringData)
      updateProblemChart(monitoringData)
      updateProblemIssues(monitoringData)
    }

    // Update Tables
    function updateMonitoringTable() {
      const tbody = document.getElementById('monitoring-table')
      const data = allData.filter(d => d.table_type === 'monitoring')
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO MONITORING DATA AVAILABLE</td></tr>'
        return
      }

      tbody.innerHTML = data.map(item => {
        const opTime = item.cumulative_op_time || 0
        let statusText, statusClass, statusAnimation, bgClass
        
        if (opTime > 10000) {
          statusText = 'CRITICAL - SERVICE REQUIRED'
          statusClass = 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
          statusAnimation = 'blink-critical'
          bgClass = 'bg-red-50 dark:bg-red-900/10'
        } else if (opTime > 5000) {
          statusText = 'WARNING'
          statusClass = 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400'
          statusAnimation = 'blink-warning'
          bgClass = 'hover:bg-amber-50 dark:hover:bg-amber-900/20'
        } else {
          statusText = 'NORMAL'
          statusClass = 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400'
          statusAnimation = ''
          bgClass = 'hover:bg-gray-50 dark:hover:bg-gray-700/50'
        }

        const conditionClass = item.ijp_condition === 'OK' 
          ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400'
          : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'

        const problemClass = item.problem_exists === 'ADA'
          ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
          : 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400'
        
        return `
          <tr class="${bgClass} transition-colors">
            <td class="px-4 py-3 text-sm font-semibold text-gray-800 dark:text-gray-200 uppercase">${item.line || '-'}</td>
            <td class="px-4 py-3 text-sm font-mono text-gray-600 dark:text-gray-400">${item.serial_number || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 uppercase">${item.machine || '-'}</td>
            <td class="px-4 py-3 text-sm font-orbitron font-bold text-gray-800 dark:text-white">${opTime} HRS</td>
            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-bold rounded-full uppercase ${conditionClass}">${item.ijp_condition || '-'}</span></td>
            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-bold rounded-full uppercase ${problemClass}">${item.problem_exists || '-'}</span></td>
            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-bold rounded-full uppercase ${statusClass} ${statusAnimation}">${statusText}</span></td>
          </tr>
        `
      }).join('')
    }

    function updateManagementTable() {
      const tbody = document.getElementById('management-table')
      const data = allData.filter(d => d.table_type === 'management')
      
      console.log('Updating management table with data:', data)
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO IJP DATA REGISTERED</td></tr>'
        return
      }

      tbody.innerHTML = data.map(item => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
          <td class="px-4 py-3 text-sm font-semibold text-gray-800 dark:text-gray-200 uppercase">${item.machine_name || '-'}</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 uppercase">${item.line || '-'}</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 uppercase">${item.serial_number || '-'}</td>
          <td class="px-4 py-3">
            <button onclick="window.showDeleteModal({id: '${item.id}'})" class="px-3 py-1 text-xs font-bold text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg uppercase transition-all">DELETE</button>
          </td>
        </tr>
      `).join('')
    }

    function updateAuditTable() {
      const tbody = document.getElementById('audit-table')
      const data = allData.filter(d => d.table_type === 'audit').sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      
      document.getElementById('audit-count').textContent = `${data.length} RECORDS`
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 uppercase">NO ACTIVITY RECORDED</td></tr>'
        return
      }

      tbody.innerHTML = data.map(item => {
        const date = new Date(item.created_at)
        const formattedDate = date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }).toUpperCase()

        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
            <td class="px-4 py-3 text-xs font-mono text-gray-600 dark:text-gray-400">${formattedDate}</td>
            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-bold bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-400 rounded uppercase">${item.user_action || '-'}</span></td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 uppercase">${item.activity || '-'}</td>
          </tr>
        `
      }).join('')
    }

    // Clock
    function updateClock() {
      const now = new Date()
      document.getElementById('current-time').textContent = now.toLocaleString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).toUpperCase()
    }

    // Global functions for inline onclick
    window.showDeleteModal = showDeleteModal

    // Initialize app
    init()
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd2560b2285da7d',t:'MTc3MDk2NDg0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
